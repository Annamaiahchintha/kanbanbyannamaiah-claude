<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deals CRM • Kanban Dashboard</title>
  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.12);
      --text: #e8ecf1;
      --muted: #a9b3c7;
      --primary: #7c5cff;
      --success: #35d49a;
      --warning: #ffc857;
      --danger: #ff5c7c;
      --ring: rgba(124,92,255,0.6);
    }

    /* Enhanced glittering gradient background */
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, #1b1941 0%, transparent 60%),
        radial-gradient(900px 600px at 110% 0%, #0e3757 0%, transparent 60%),
        radial-gradient(600px 400px at 50% 120%, #2d1b69 0%, transparent 50%),
        linear-gradient(120deg, #0b1020 0%, #0d1226 60%, #0b1020 100%);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* Enhanced star field with twinkling */
    .stars{ 
      position:fixed; inset:0; pointer-events:none; 
      background-image: 
        radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.4), rgba(255,255,255,0)), 
        radial-gradient(1px 1px at 70% 60%, rgba(255,255,255,.3), rgba(255,255,255,0)), 
        radial-gradient(1.5px 1.5px at 40% 80%, rgba(255,255,255,.35), rgba(255,255,255,0)),
        radial-gradient(1px 1px at 90% 10%, rgba(124,92,255,.4), rgba(124,92,255,0)),
        radial-gradient(1px 1px at 15% 90%, rgba(53,212,154,.3), rgba(53,212,154,0)); 
      filter: blur(.2px) drop-shadow(0 0 2px rgba(255,255,255,.15)); 
      animation: twinkle 4s ease-in-out infinite alternate;
    }
    @keyframes twinkle{ 0%{opacity:.8} 100%{opacity:1} }

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(10,12,26,.9), rgba(10,12,26,.3));
      border-bottom: 1px solid var(--panel-strong);
      box-shadow: 0 4px 20px rgba(0,0,0,.2);
    }
    .container{ max-width:1200px; margin:0 auto; padding:16px 20px; }
    .title{
      display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.3px;
    }
    .shiny{ 
      position:relative; display:inline-block; 
      background:linear-gradient(90deg, #9aa0ff, #7c5cff, #35d49a, #7c5cff, #9aa0ff); 
      background-size:300% 100%; 
      -webkit-background-clip:text; background-clip:text; color:transparent; 
      animation: shine 4s ease-in-out infinite; 
    }
    @keyframes shine{ 0%,100%{background-position:300% 0} 50%{background-position: -100% 0} }

    .toolbar{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-top:12px; }
    .btn{
      appearance:none; border:1px solid var(--panel-strong); color:var(--text);
      background:linear-gradient(145deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      padding:11px 16px; border-radius:16px; font-weight:600; cursor:pointer; 
      transition: transform .1s ease, box-shadow .25s ease, border-color .2s ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 12px 25px rgba(0,0,0,.3);
      position:relative; overflow:hidden;
    }
    .btn::before{
      content:''; position:absolute; inset:0; background:linear-gradient(45deg, transparent, rgba(255,255,255,.1), transparent);
      transform:translateX(-100%); transition:transform .6s ease;
    }
    .btn:hover::before{ transform:translateX(100%); }
    .btn:hover{ 
      transform: translateY(-2px); 
      box-shadow: 0 16px 35px rgba(0,0,0,.35), 0 0 0 6px var(--ring); 
      border-color: rgba(255,255,255,.25); 
    }
    .btn:active{ transform: translateY(-1px); }
    .btn.primary{ 
      border-color: rgba(124,92,255,.7); 
      box-shadow: inset 0 0 0 1px rgba(124,92,255,.5), 0 12px 28px rgba(124,92,255,.3); 
    }

    #search{
      padding:11px 14px; border-radius:14px; border:1px solid var(--panel-strong);
      background:linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      color:var(--text); outline:none; 
      transition: all .25s ease;
      box-shadow: inset 0 2px 4px rgba(0,0,0,.1);
    }
    #search:focus{ 
      box-shadow: 0 0 0 4px var(--ring), inset 0 2px 4px rgba(0,0,0,.1); 
      border-color: rgba(124,92,255,.7); 
    }

    .kanban{
      display:grid; grid-template-columns: repeat(5, 1fr); gap:18px; 
      padding:24px; max-width:1400px; margin:15px auto 80px;
    }
    @media (max-width: 1100px){ .kanban{ grid-template-columns: repeat(3,1fr);} }
    @media (max-width: 800px){ .kanban{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 560px){ .kanban{ grid-template-columns: 1fr;} }

    .column{ 
      background: linear-gradient(145deg, var(--panel), rgba(255,255,255,.02)); 
      border:1px solid var(--panel-strong); border-radius:20px; min-height:280px; 
      display:flex; flex-direction:column; overflow:hidden; position:relative; 
      transition: transform .2s ease, box-shadow .3s ease;
    }
    .column::after{ 
      content:""; position:absolute; inset:0; pointer-events:none; 
      background: radial-gradient(140px 50px at top left, rgba(255,255,255,.12), transparent 70%); 
    }
    .column:hover{ transform:translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,.15); }

    .col-head{ 
      display:flex; align-items:center; justify-content:space-between; gap:8px; 
      padding:14px 16px; border-bottom:1px solid var(--panel-strong); 
      background: linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); 
    }
    .col-title{ font-weight:700; font-size:13px; letter-spacing:.4px; text-transform:uppercase; color:var(--muted); }
    .badge{ 
      font-size:11px; font-weight:700; 
      background: linear-gradient(145deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); 
      padding:4px 10px; border-radius:999px; border:1px solid var(--panel-strong); 
      color:var(--text); min-width:22px; text-align:center;
    }

    .deal-list{ padding:14px; display:flex; flex-direction:column; gap:12px; flex:1; }

    .card{
      user-select:none; cursor:grab; 
      background: linear-gradient(145deg, rgba(255,255,255,.15), rgba(255,255,255,.06));
      border:1px solid var(--panel-strong); border-radius:18px; padding:14px; 
      display:grid; gap:10px; 
      box-shadow: 0 8px 25px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.08);
      transition: transform .15s ease, box-shadow .25s ease, border-color .2s ease;
      position:relative; overflow:hidden;
    }
    .card::before{
      content:''; position:absolute; top:0; left:-100%; width:100%; height:2px;
      background:linear-gradient(90deg, transparent, var(--primary), transparent);
      transition:left .5s ease;
    }
    .card:hover::before{ left:100%; }
    .card:hover{ 
      transform: translateY(-3px) scale(1.02); 
      box-shadow: 0 20px 40px rgba(0,0,0,.35), 0 0 0 6px var(--ring); 
      border-color: rgba(255,255,255,.3); 
    }
    .card:active{ cursor:grabbing; transform: translateY(-1px) scale(.98); }
    .card h4{ margin:0; font-size:15px; font-weight:600; }
    .meta{ display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:12px; }
    .tag{ 
      background: linear-gradient(145deg, rgba(255,255,255,.15), rgba(255,255,255,.08)); 
      border:1px solid var(--panel-strong); padding:3px 8px; border-radius:999px; 
      font-weight:500; backdrop-filter:blur(4px);
    }

    .dropping{ 
      outline: 3px dashed rgba(124,92,255,.8); outline-offset:-6px; 
      background: linear-gradient(145deg, rgba(124,92,255,.1), rgba(124,92,255,.05));
      transform:scale(1.02);
    }

    /* Enhanced Modal */
    dialog{ 
      border:1px solid var(--panel-strong); border-radius:20px; 
      background: linear-gradient(145deg, rgba(255,255,255,.15), rgba(255,255,255,.08)); 
      color:var(--text); width:min(720px, 92vw);
      box-shadow: 0 25px 50px rgba(0,0,0,.5);
      backdrop-filter:blur(8px);
    }
    dialog::backdrop{ 
      backdrop-filter: blur(8px); 
      background: rgba(4,6,16,.7); 
      animation: fadeIn .3s ease;
    }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    form{ display:grid; gap:14px; padding:20px; }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media(max-width:560px){ .grid-2{ grid-template-columns: 1fr; } }
    label{ font-size:12px; color:var(--muted); font-weight:600; margin-bottom:4px; display:block; }
    input, select, textarea{
      width:100%; padding:12px 14px; border-radius:14px; border:1px solid var(--panel-strong);
      background: linear-gradient(145deg, rgba(255,255,255,.12), rgba(255,255,255,.05)); 
      color:var(--text); outline:none; 
      transition: box-shadow .25s ease, border-color .2s ease, transform .1s ease;
      font-family:inherit;
    }
    input:focus, select:focus, textarea:focus{ 
      box-shadow: 0 0 0 4px var(--ring); border-color: rgba(124,92,255,.7); 
      transform:translateY(-1px);
    }
    textarea{ min-height:90px; resize:vertical; }

    .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:8px; }
    .btn.danger{ 
      border-color: rgba(255,92,124,.6); 
      box-shadow: inset 0 0 0 1px rgba(255,92,124,.4), 0 12px 25px rgba(255,92,124,.2); 
    }
    .btn.success{ 
      border-color: rgba(53,212,154,.6); 
      box-shadow: inset 0 0 0 1px rgba(53,212,154,.4), 0 12px 25px rgba(53,212,154,.2); 
    }

    /* Enhanced animations */
    .shake{ animation: shake .4s ease-in-out 2; }
    @keyframes shake { 0%,100%{ transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }

    .pulse{ animation: pulse .8s ease-in-out 1; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }

    /* Enhanced Toasts */
    .toast-area{ position:fixed; right:20px; bottom:20px; display:grid; gap:10px; z-index:60; }
    .toast{ 
      background: linear-gradient(145deg, rgba(25,30,60,.95), rgba(15,20,40,.95)); 
      border:1px solid var(--panel-strong); padding:12px 16px; border-radius:14px; 
      box-shadow: 0 10px 30px rgba(0,0,0,.4); font-size:13px; font-weight:500;
      backdrop-filter:blur(12px);
      animation: slideIn .3s ease;
      max-width:300px;
    }
    @keyframes slideIn{ from{transform:translateX(100%); opacity:0} to{transform:translateX(0); opacity:1} }

    /* Confetti Canvas */
    #confetti{ position:fixed; inset:0; pointer-events:none; z-index:100; }

    /* Loading states */
    .loading{ opacity:.6; pointer-events:none; filter:blur(1px); }

    /* Success states */
    .success-glow{ 
      animation: successGlow 1s ease-out;
      box-shadow: 0 0 20px rgba(53,212,154,.6) !important;
    }
    @keyframes successGlow{ 0%{box-shadow: 0 0 0 rgba(53,212,154,.6)} 50%{box-shadow: 0 0 25px rgba(53,212,154,.8)} 100%{box-shadow: 0 0 20px rgba(53,212,154,.6)} }
  </style>
</head>
<body>
  <div class="stars"></div>
  <canvas id="confetti"></canvas>
  
  <header>
    <div class="container">
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z" stroke="currentColor" stroke-width="1.5"/>
          <path d="M7 7h10v10H7z" fill="currentColor" opacity=".12"/>
          <path d="M7 10h10" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="9.5" cy="15" r="1.2" fill="currentColor"/>
          <circle cx="14.5" cy="15" r="1.2" fill="currentColor"/>
        </svg>
        <span class="shiny" style="font-size:20px">Deals CRM • Kanban Dashboard</span>
      </div>
      <div class="toolbar">
        <button class="btn primary" id="addDealBtn">✨ Add Deal</button>
        <button class="btn" id="exportBtn">📥 Export</button>
        <button class="btn" id="importBtn">📤 Import</button>
        <button class="btn" id="clearBtn">🗑️ Clear All</button>
        <input id="search" placeholder="🔍 Search deals..." />
      </div>
    </div>
  </header>

  <main class="kanban" id="board"></main>

  <dialog id="dealModal">
    <form id="dealForm" method="dialog">
      <input type="hidden" id="dealId" />
      <h3 style="margin:0 0 16px 0; color:var(--primary)">Deal Details</h3>
      
      <div class="grid-2">
        <div>
          <label>Deal Title *</label>
          <input id="title" required placeholder="e.g., ACME Corp - Annual License" />
        </div>
        <div>
          <label>Deal Value (USD)</label>
          <input id="value" type="number" min="0" step="100" placeholder="e.g., 25000" />
        </div>
      </div>
      
      <div class="grid-2">
        <div>
          <label>Deal Owner</label>
          <input id="owner" placeholder="e.g., Sarah Johnson" />
        </div>
        <div>
          <label>Due Date</label>
          <input id="due" type="date" />
        </div>
      </div>
      
      <div class="grid-2">
        <div>
          <label>Pipeline Stage</label>
          <select id="stage">
            <option>New</option>
            <option>Qualified</option>
            <option>Proposal</option>
            <option>Won</option>
            <option>Lost</option>
          </select>
        </div>
        <div>
          <label>Priority Level</label>
          <select id="priority">
            <option>Normal</option>
            <option>High</option>
            <option>Urgent</option>
          </select>
        </div>
      </div>
      
      <div>
        <label>Deal Notes</label>
        <textarea id="notes" placeholder="Add context, next steps, or important details..."></textarea>
      </div>
      
      <div class="actions">
        <button class="btn danger" type="button" id="deleteBtn">🗑 Delete</button>
        <div style="flex:1"></div>
        <button class="btn" value="cancel" type="button" id="cancelBtn">Cancel</button>
        <button class="btn success" id="saveBtn" value="save" type="submit">💾 Save Deal</button>
      </div>
    </form>
  </dialog>

  <div class="toast-area" id="toasts"></div>

  <script>
    /******************** Enhanced Utilities ********************/
    const STAGES = ["New","Qualified","Proposal","Won","Lost"];
    const STAGE_COLORS = {
      "New": "#7c5cff",
      "Qualified": "#ffc857", 
      "Proposal": "#ff9500",
      "Won": "#35d49a",
      "Lost": "#ff5c7c"
    };
    
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : 'deal-'+Math.random().toString(36).slice(2,11));
    const storeKey = 'deals-crm-enhanced-v2';

    /******************** Enhanced Audio System ********************/
    const audio = {
      bell() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Success chime sequence
        [880, 1100, 1320].forEach((freq, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = i === 2 ? 'triangle' : 'sine';
          o.frequency.value = freq;
          o.connect(g);
          g.connect(ctx.destination);
          const start = ctx.currentTime + i * 0.15;
          g.gain.setValueAtTime(0.0001, start);
          g.gain.exponentialRampToValueAtTime(0.15, start + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, start + 0.4);
          o.start(start);
          o.stop(start + 0.45);
        });
      },

      buzzer() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sawtooth';
        o.frequency.value = 150;
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.3);
        o.start();
        o.stop(ctx.currentTime + 0.32);
      },

      ding() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 800;
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.4);
        o.start();
        o.stop(ctx.currentTime + 0.42);
      }
    };

    /******************** Enhanced Toast System ********************/
    const toast = (msg, type = 'info', ms = 3000) => {
      const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
      const el = document.createElement('div');
      el.className = 'toast';
      el.innerHTML = `${icons[type] || icons.info} ${msg}`;
      $('#toasts').appendChild(el);
      
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateX(100%)';
      }, ms - 300);
      
      setTimeout(() => el.remove(), ms);
    };

    /******************** Enhanced Confetti System ********************/
    const confetti = (() => {
      const canvas = document.getElementById('confetti');
      const ctx = canvas.getContext('2d');
      
      const resize = () => {
        canvas.width = innerWidth;
        canvas.height = innerHeight;
      };
      addEventListener('resize', resize);
      resize();
      
      let pieces = [];
      const colors = ['#7c5cff', '#9aa0ff', '#35d49a', '#ffc857', '#ff5c7c', '#7cc3ff', '#ff9500'];
      
      function burst(x = innerWidth / 2, y = innerHeight / 2, count = 150) {
        for (let i = 0; i < count; i++) {
          const angle = (Math.PI * 2 * i) / count + Math.random() * 0.5;
          const velocity = Math.random() * 8 + 4;
          pieces.push({
            x, y,
            vx: Math.cos(angle) * velocity,
            vy: Math.sin(angle) * velocity,
            w: 2 + Math.random() * 4,
            h: 6 + Math.random() * 12,
            rot: Math.random() * Math.PI,
            vr: (Math.random() - 0.5) * 0.4,
            color: colors[Math.floor(Math.random() * colors.length)],
            life: 60 + Math.random() * 60,
            gravity: 0.15 + Math.random() * 0.1
          });
        }
        loop();
      }
      
      let raf = null;
      function loop() {
        if (raf) return;
        raf = requestAnimationFrame(draw);
      }
      
      function draw() {
        raf = null;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        pieces.forEach(p => {
          p.vy += p.gravity;
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.life -= 1;
        });
        
        pieces = pieces.filter(p => p.life > 0 && p.y < canvas.height + 50);
        
        pieces.forEach(p => {
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          ctx.restore();
        });
        
        if (pieces.length) {
          raf = requestAnimationFrame(draw);
        }
      }
      
      return { burst };
    })();

    /******************** Enhanced State Management ********************/
    let deals = load();
    
    function load() {
      try {
        const stored = localStorage.getItem(storeKey);
        return stored ? JSON.parse(stored) : generateSampleDeals();
      } catch (err) {
        console.warn('Failed to load deals:', err);
        return generateSampleDeals();
      }
    }
    
    function save() {
      try {
        localStorage.setItem(storeKey, JSON.stringify(deals));
      } catch (err) {
        console.error('Failed to save deals:', err);
        toast('Failed to save data', 'error');
      }
    }

    function generateSampleDeals() {
      const now = new Date();
      const addDays = (days) => new Date(now.getTime() + days * 86400000).toISOString().slice(0, 10);
      
      return [
        {
          id: uid(),
          title: 'TechCorp - Enterprise License',
          value: 45000,
          owner: 'Sarah Chen',
          due: addDays(7),
          stage: 'New',
          priority: 'High',
          notes: 'Initial discovery call scheduled. 500+ employees, looking for comprehensive solution.'
        },
        {
          id: uid(),
          title: 'GlobalSoft - Annual Renewal',
          value: 28000,
          owner: 'Mike Rodriguez',
          due: addDays(14),
          stage: 'Qualified',
          priority: 'Normal',
          notes: 'Existing customer renewal. Security audit completed, waiting on legal review.'
        },
        {
          id: uid(),
          title: 'StartupXYZ - Growth Package',
          value: 15000,
          owner: 'Emily Wang',
          due: addDays(5),
          stage: 'Proposal',
          priority: 'Urgent',
          notes: 'Proposal sent yesterday. CEO wants to close by month-end. Strong buying signals.'
        },
        {
          id: uid(),
          title: 'MegaCorp - Integration Services',
          value: 75000,
          owner: 'David Kumar',
          due: addDays(-2),
          stage: 'Won',
          priority: 'High',
          notes: 'Closed! Celebration dinner with team. Implementation starts next quarter.'
        },
        {
          id: uid(),
          title: 'SmallBiz Inc - Basic Plan',
          value: 8500,
          owner: 'Lisa Thompson',
          due: addDays(21),
          stage: 'New',
          priority: 'Normal',
          notes: 'Inbound lead from website. Scheduling demo for next week.'
        }
      ];
    }

    /******************** Enhanced Rendering ********************/
    const board = $('#board');
    
    function render() {
      const query = $('#search').value.trim().toLowerCase();
      board.innerHTML = '';
      
      STAGES.forEach(stage => {
        const col = createColumn(stage);
        board.appendChild(col);
        
        const stageDeals = deals.filter(d => d.stage === stage && matchesQuery(d, query));
        const dealList = $('.deal-list', col);
        
        stageDeals.forEach(deal => {
          dealList.appendChild(createDealCard(deal));
        });
        
        updateStageCount(stage);
      });
    }
    
    function createColumn(stage) {
      const col = document.createElement('section');
      col.className = 'column';
      col.dataset.stage = stage;
      
      col.innerHTML = `
        <div class="col-head">
          <div class="col-title">${stage}</div>
          <div class="badge" id="count-${stage}">0</div>
        </div>
        <div class="deal-list" role="list" aria-label="${stage}"></div>
      `;
      
      enableDragAndDrop(col);
      return col;
    }
    
    function createDealCard(deal) {
      const el = document.createElement('article');
      el.className = 'card';
      el.setAttribute('draggable', 'true');
      el.dataset.id = deal.id;
      
      const isOverdue = deal.due && new Date(deal.due) < new Date() && !['Won', 'Lost'].includes(deal.stage);
      const priorityEmoji = { 'Urgent': '🔥', 'High': '⚡', 'Normal': '📋' }[deal.priority] || '📋';
      
      el.innerHTML = `
        <h4>${escapeHtml(deal.title)}</h4>
        <div class="meta">
          <span class="tag" style="background: linear-gradient(135deg, rgba(53,212,154,.2), rgba(53,212,154,.1));">
            💰 ${Number(deal.value || 0).toLocaleString()}
          </span>
          <span class="tag">👤 ${escapeHtml(deal.owner || 'Unassigned')}</span>
          ${deal.due ? `<span class="tag" style="${isOverdue ? 'background: linear-gradient(135deg, rgba(255,92,124,.3), rgba(255,92,124,.1)); color: #ff5c7c;' : ''}">
            🗓 ${formatDate(deal.due)}
          </span>` : ''}
          <span class="tag">${priorityEmoji} ${deal.priority || 'Normal'}</span>
        </div>
        ${deal.notes ? `<div style="font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.4;">
          ${escapeHtml(deal.notes.slice(0, 80))}${deal.notes.length > 80 ? '...' : ''}
        </div>` : ''}
      `;
      
      // Event listeners
      el.addEventListener('dblclick', () => openModal(deal.id));
      el.addEventListener('click', () => openModal(deal.id));
      
      // Drag and drop
      el.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', deal.id);
        requestAnimationFrame(() => {
          el.style.opacity = '0.5';
          el.style.transform = 'rotate(5deg)';
        });
        audio.ding();
      });
      
      el.addEventListener('dragend', () => {
        el.style.opacity = '';
        el.style.transform = '';
      });
      
      return el;
    }
    
    function enableDragAndDrop(col) {
      const handleDragOver = (e) => {
        e.preventDefault();
        col.classList.add('dropping');
      };
      
      const handleDragLeave = () => {
        col.classList.remove('dropping');
      };
      
      const handleDrop = (e) => {
        e.preventDefault();
        col.classList.remove('dropping');
        
        const dealId = e.dataTransfer.getData('text/plain');
        const deal = deals.find(d => d.id === dealId);
        if (!deal) return;
        
        const fromStage = deal.stage;
        const toStage = col.dataset.stage;
        
        if (fromStage === toStage) return;
        
        deal.stage = toStage;
        save();
        render();
        
        // Enhanced feedback based on stage
        if (toStage === 'Won' && fromStage !== 'Won') {
          confetti.burst(e.clientX, e.clientY, 200);
          audio.bell();
          toast(`🎉 Congratulations! Deal won: ${deal.title}`, 'success');
          
          // Add success glow to the new card
          setTimeout(() => {
            const newCard = document.querySelector(`[data-id="${dealId}"]`);
            if (newCard) {
              newCard.classList.add('success-glow');
              setTimeout(() => newCard.classList.remove('success-glow'), 2000);
            }
          }, 100);
        } else if (toStage === 'Lost' && fromStage !== 'Lost') {
          audio.buzzer();
          toast(`💔 Deal moved to Lost: ${deal.title}`, 'warning');
        } else {
          audio.ding();
          toast(`📋 Deal moved to ${toStage}: ${deal.title}`, 'info');
        }
      };
      
      ['dragenter', 'dragover'].forEach(event => {
        col.addEventListener(event, handleDragOver);
      });
      
      ['dragleave', 'drop'].forEach(event => {
        col.addEventListener(event, handleDragLeave);
      });
      
      col.addEventListener('drop', handleDrop);
    }
    
    function matchesQuery(deal, query) {
      if (!query) return true;
      const searchText = [deal.title, deal.owner, deal.notes].join(' ').toLowerCase();
      return searchText.includes(query);
    }
    
    function updateStageCount(stage) {
      const count = deals.filter(d => d.stage === stage).length;
      const badge = document.getElementById(`count-${stage}`);
      if (badge) {
        badge.textContent = count;
        badge.style.background = count > 0 ? 
          `linear-gradient(135deg, ${STAGE_COLORS[stage]}40, ${STAGE_COLORS[stage]}20)` : 
          '';
      }
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[char]));
    }
    
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const today = new Date();
      const diffTime = date - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Tomorrow';
      if (diffDays === -1) return 'Yesterday';
      if (diffDays < 0) return `${Math.abs(diffDays)}d overdue`;
      if (diffDays < 7) return `${diffDays}d`;
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    /******************** Enhanced Modal System ********************/
    const modal = $('#dealModal');
    const form = $('#dealForm');

    function openModal(dealId = null) {
      const deal = dealId ? deals.find(d => d.id === dealId) : null;
      
      // Populate form
      $('#dealId').value = deal?.id || '';
      $('#title').value = deal?.title || '';
      $('#value').value = deal?.value || '';
      $('#owner').value = deal?.owner || '';
      $('#due').value = deal?.due || '';
      $('#stage').value = deal?.stage || STAGES[0];
      $('#priority').value = deal?.priority || 'Normal';
      $('#notes').value = deal?.notes || '';
      
      // Show/hide delete button
      $('#deleteBtn').style.display = deal ? 'inline-flex' : 'none';
      
      // Update modal title
      const title = modal.querySelector('h3');
      title.textContent = deal ? 'Edit Deal' : 'New Deal';
      
      modal.showModal();
      $('#title').focus();
    }

    // Form submission
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const dealId = $('#dealId').value || uid();
      const dealData = {
        id: dealId,
        title: $('#title').value.trim(),
        value: Number($('#value').value) || 0,
        owner: $('#owner').value.trim(),
        due: $('#due').value || null,
        stage: $('#stage').value,
        priority: $('#priority').value,
        notes: $('#notes').value.trim()
      };
      
      // Validation
      if (!dealData.title) {
        form.classList.add('shake');
        audio.buzzer();
        toast('Please enter a deal title', 'error');
        setTimeout(() => form.classList.remove('shake'), 400);
        $('#title').focus();
        return;
      }
      
      // Save deal
      const existingIndex = deals.findIndex(d => d.id === dealId);
      if (existingIndex >= 0) {
        deals[existingIndex] = dealData;
        toast('✅ Deal updated successfully', 'success');
      } else {
        deals.push(dealData);
        toast('✅ Deal added successfully', 'success');
        if (dealData.stage === 'Won') {
          setTimeout(() => {
            confetti.burst(innerWidth - 150, 100, 120);
            audio.bell();
          }, 200);
        }
      }
      
      save();
      render();
      modal.close();
      audio.ding();
    });

    // Delete button
    $('#deleteBtn').addEventListener('click', () => {
      const dealId = $('#dealId').value;
      if (!dealId) return;
      
      const deal = deals.find(d => d.id === dealId);
      if (!deal) return;
      
      if (confirm(`Are you sure you want to delete "${deal.title}"?\n\nThis action cannot be undone.`)) {
        deals = deals.filter(d => d.id !== dealId);
        save();
        render();
        modal.close();
        toast('🗑️ Deal deleted', 'warning');
        audio.buzzer();
      }
    });

    // Cancel button
    $('#cancelBtn').addEventListener('click', () => {
      modal.close();
    });

    /******************** Enhanced Toolbar Functions ********************/
    
    // Add Deal button
    $('#addDealBtn').addEventListener('click', () => {
      openModal();
    });

    // Export functionality
    $('#exportBtn').addEventListener('click', () => {
      try {
        const exportData = {
          version: '2.0',
          exported: new Date().toISOString(),
          deals: deals
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
          type: 'application/json' 
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `deals-export-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        toast('📥 Deals exported successfully', 'success');
        audio.ding();
      } catch (err) {
        toast('Failed to export deals', 'error');
        audio.buzzer();
      }
    });

    // Import functionality
    $('#importBtn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      
      input.onchange = () => {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            
            // Handle different export formats
            let importedDeals = [];
            if (Array.isArray(data)) {
              importedDeals = data;
            } else if (data.deals && Array.isArray(data.deals)) {
              importedDeals = data.deals;
            } else {
              throw new Error('Invalid file format');
            }
            
            // Validate and normalize deals
            const normalizedDeals = importedDeals.map(deal => ({
              id: deal.id || uid(),
              title: deal.title || 'Untitled Deal',
              value: Number(deal.value) || 0,
              owner: deal.owner || '',
              due: deal.due || null,
              stage: STAGES.includes(deal.stage) ? deal.stage : 'New',
              priority: ['Normal', 'High', 'Urgent'].includes(deal.priority) ? deal.priority : 'Normal',
              notes: deal.notes || ''
            }));
            
            if (confirm(`Import ${normalizedDeals.length} deals?\n\nThis will replace your current deals.`)) {
              deals = normalizedDeals;
              save();
              render();
              toast(`✅ Successfully imported ${normalizedDeals.length} deals`, 'success');
              confetti.burst(innerWidth / 2, 100, 150);
              audio.bell();
            }
          } catch (err) {
            console.error('Import error:', err);
            toast('❌ Failed to import: Invalid file format', 'error');
            audio.buzzer();
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    });

    // Clear all functionality
    $('#clearBtn').addEventListener('click', () => {
      if (deals.length === 0) {
        toast('No deals to clear', 'info');
        return;
      }
      
      if (confirm(`Clear all ${deals.length} deals?\n\nThis action cannot be undone.`)) {
        deals = [];
        save();
        render();
        toast('🗑️ All deals cleared', 'warning');
        audio.buzzer();
      }
    });

    // Search functionality
    $('#search').addEventListener('input', () => {
      render();
    });

    /******************** Enhanced Notifications ********************/
    
    // Check for overdue deals
    function checkOverdueDeals() {
      const today = new Date().toISOString().slice(0, 10);
      const overdueDeals = deals.filter(d => 
        d.due && 
        d.due <= today && 
        !['Won', 'Lost'].includes(d.stage)
      );
      
      if (overdueDeals.length > 0) {
        const message = overdueDeals.length === 1 
          ? `🔔 1 deal is overdue: ${overdueDeals[0].title}` 
          : `🔔 ${overdueDeals.length} deals are overdue`;
        
        toast(message, 'warning', 5000);
        audio.buzzer();
      }
    }

    // Check overdue every 5 minutes
    setInterval(checkOverdueDeals, 5 * 60 * 1000);

    /******************** Keyboard Shortcuts ********************/
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + N: New deal
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        openModal();
      }
      
      // Escape: Close modal
      if (e.key === 'Escape' && modal.open) {
        modal.close();
      }
      
      // Ctrl/Cmd + S: Save (when modal is open)
      if ((e.ctrlKey || e.metaKey) && e.key === 's' && modal.open) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    /******************** Initialization ********************/
    
    // Initial render
    render();
    
    // Check for overdue deals on load
    setTimeout(checkOverdueDeals, 2000);
    
    // Performance monitoring
    console.log('🚀 Deals CRM Dashboard initialized');
    console.log(`📊 Loaded ${deals.length} deals across ${STAGES.length} stages`);
  </script>
</body>
</html>
